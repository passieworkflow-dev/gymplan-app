<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Gym Plan App (MVP)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-6">
  <div class="max-w-2xl w-full bg-white shadow rounded-lg p-6">

    <!-- Auth Section -->
    <div id="auth" class="space-y-4">
      <h1 class="text-2xl font-bold">Gym Plan App — MVP</h1>
      <div id="auth-forms">
        <input id="email" type="email" placeholder="Email" class="w-full p-2 border rounded" />
        <input id="password" type="password" placeholder="Password" class="w-full p-2 border rounded" />
        <div class="flex gap-2">
          <button id="signupBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Sign up</button>
          <button id="loginBtn" class="bg-green-600 text-white px-4 py-2 rounded">Log in</button>
        </div>
        <p id="authMsg" class="text-sm text-red-500"></p>
      </div>
    </div>

    <!-- Main App Section -->
    <div id="app" class="hidden space-y-4">
      <div class="flex justify-between items-center">
        <h2 class="text-xl font-semibold">Your plan</h2>
        <div>
          <button id="logoutBtn" class="text-sm text-gray-600">Log out</button>
          <button id="previousPlansBtn" class="text-sm text-blue-600 ml-2">Previous Chosen Plans</button>
        </div>
      </div>

      <div id="planCard" class="p-4 border rounded bg-gray-50">
        <p id="planStatus" class="text-sm text-gray-600">Loading plan…</p>
        <pre id="planJson" class="text-xs mt-2 overflow-auto"></pre>
      </div>

      <div id="planSelection" class="hidden p-4 border rounded bg-gray-50">
        <h3 class="font-medium">Choose Your Plan</h3>
        <div id="planOptions" class="mt-4 space-y-4"></div>
      </div>

      <div>
        <h3 class="font-medium">Chat / Feedback</h3>
        <div id="messages" class="h-40 overflow-auto border rounded p-2 bg-white mb-2"></div>
        <div class="flex gap-2">
          <input id="msgInput" class="flex-1 p-2 border rounded" placeholder="Type a message..." />
          <button id="sendMsgBtn" class="bg-indigo-600 text-white px-4 py-2 rounded">Send</button>
        </div>
      </div>

      <div class="flex gap-2">
        <button id="generatePlanBtn" class="bg-green-600 text-white px-4 py-2 rounded flex-1">Generate New Weekly Plan</button>
        <button id="generateTodayBtn" class="bg-blue-600 text-white px-4 py-2 rounded flex-1">Generate Today's Plan</button>
      </div>
      <div id="planDisplay" class="mt-4 p-4 border rounded bg-gray-50 whitespace-pre-wrap"></div>
    </div>

    <!-- Previous Plans Page -->
    <div id="previousPlansPage" class="hidden space-y-4">
      <div class="flex justify-between items-center">
        <h2 class="text-xl font-semibold">Previous Chosen Plans</h2>
        <button id="backToAppBtn" class="text-sm text-blue-600">Back to Main App</button>
      </div>
      <div id="previousPlansContent" class="p-4 border rounded bg-gray-50">
        <p class="text-sm text-gray-600">Loading previous plans...</p>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = "https://utrmpajuymlcqixcdter.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY_HERE";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = id => document.getElementById(id);

    const emailInput = $('email'), passInput = $('password');
    const signupBtn = $('signupBtn'), loginBtn = $('loginBtn'), logoutBtn = $('logoutBtn');
    const authMsg = $('authMsg');
    const authDiv = $('auth'), appDiv = $('app'), previousPlansPage = $('previousPlansPage');
    const planStatus = $('planStatus'), planJson = $('planJson');
    const messagesDiv = $('messages'), msgInput = $('msgInput'), sendMsgBtn = $('sendMsgBtn');
    const previousPlansBtn = $('previousPlansBtn'), previousPlansContent = $('previousPlansContent'), backToAppBtn = $('backToAppBtn');
    const generatePlanBtn = $('generatePlanBtn'), generateTodayBtn = $('generateTodayBtn');

    signupBtn.onclick = async () => {
      authMsg.textContent = "";
      const email = emailInput.value.trim(), password = passInput.value.trim();
      if (!email || !password) { authMsg.textContent = "Provide email & password"; return; }
      const { error } = await supabaseClient.auth.signUp({ email, password });
      authMsg.textContent = error ? error.message : "Check your email to confirm (if enabled)";
    };

    loginBtn.onclick = async () => {
      authMsg.textContent = "";
      const email = emailInput.value.trim(), password = passInput.value.trim();
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) { authMsg.textContent = error.message; return; }
      initApp();
    };

    logoutBtn.onclick = async () => {
      await supabaseClient.auth.signOut();
      showAuth();
    };

    function showAuth() { authDiv.classList.remove('hidden'); appDiv.classList.add('hidden'); previousPlansPage.classList.add('hidden'); }
    function showApp() { authDiv.classList.add('hidden'); appDiv.classList.remove('hidden'); previousPlansPage.classList.add('hidden'); }
    function showPreviousPlans() { authDiv.classList.add('hidden'); appDiv.classList.add('hidden'); previousPlansPage.classList.remove('hidden'); }

    async function initApp() {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) { showAuth(); return; }
      showApp();
      await loadPlanForUser(user.id);
      await loadMessages(user.id);

      supabaseClient.channel('public:messages')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
          if (payload.new.user_id === user.id) addMessageToUI(payload.new);
        })
        .subscribe();
    }

    async function loadPlanForUser(userId) {
      const today = new Date().toISOString().slice(0, 10);
      planStatus.textContent = "Fetching plan…";
      const { data, error } = await supabaseClient
        .from('plans')
        .select('id, plan_date, plan_json, created_at')
        .eq('user_id', userId)
        .eq('plan_date', today)
        .limit(1)
        .order('created_at', { ascending: false });
      if (error) { planStatus.textContent = "Error loading plan: " + error.message; planJson.textContent = ""; return; }
      if (!data || data.length === 0) { planStatus.textContent = "No plan for today. Generate one below!"; planJson.textContent = ""; return; }
      planStatus.textContent = "Today's plan:";
      planJson.textContent = data[0].plan_json.replace(/\\n/g, '\n');
    }

    async function loadMessages(userId) {
      messagesDiv.innerHTML = "<p class='text-sm text-gray-500'>Loading messages…</p>";
      const { data, error } = await supabaseClient
        .from('messages')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: true });
      if (error) { messagesDiv.innerHTML = "<p class='text-sm text-red-500'>Error loading messages</p>"; return; }
      messagesDiv.innerHTML = '';
      data.forEach(addMessageToUI);
    }

    function addMessageToUI(m) {
      const el = document.createElement('div');
      el.className = 'p-2 border-b text-sm';
      el.textContent = (new Date(m.created_at)).toLocaleString() + " — " + m.content;
      messagesDiv.appendChild(el);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    sendMsgBtn.onclick = async () => {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) { alert('Please login'); return; }
      const content = msgInput.value.trim();
      if (!content) return;
      const { error } = await supabaseClient.from('messages').insert([{ user_id: user.id, content }]);
      if (error) return alert('Error: ' + error.message);
      msgInput.value = '';
    };

    async function generatePlan() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) { alert('Please log in first.'); return; }

        const { data: profile, error } = await supabaseClient
          .from('user_profiles')
          .select('*')
          .eq('user_id', user.id)
          .single();
        if (error || !profile) { alert('User profile not found. Complete profile.'); return; }

        const userData = { ...profile, isFirstWeek: true, feedbackSummary: '', user_id: user.id };
        const response = await fetch('/api/generate-plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userData)
        });
        if (!response.ok) throw new Error('Failed to generate plan options: ' + response.statusText);
        const result = await response.json();
        displayPlanOptions(result);
      } catch (err) {
        console.error(err); alert('Error: ' + err.message);
      }
    }

    function displayPlanOptions(plans) {
      const optionsDiv = $('planOptions'); optionsDiv.innerHTML = '';
      ['planA','planB','planC'].forEach(planKey => {
        const plan = plans[planKey];
        if (plan && plan.summary) {
          const planDiv = document.createElement('div');
          planDiv.className = 'p-4 border rounded bg-white';
          planDiv.innerHTML = `
            <h4 class="font-semibold">${planKey.toUpperCase()}</h4>
            <p><strong>Summary:</strong> ${plan.summary}</p>
            <p><strong>Details:</strong> ${plan.details ? plan.details.replace(/\n/g,'<br>') : 'No details'}</p>
            <p><strong>Notes:</strong> ${plan.notes || 'No notes'}</p>
            <button class="chooseBtn bg-blue-600 text-white px-4 py-2 rounded mt-2" data-plan="${planKey}">Choose This Plan</button>
          `;
          optionsDiv.appendChild(planDiv);
        }
      });
      $('planSelection').classList.remove('hidden');
    }

    async function choosePlan(planKey) {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const userData = { chosenPlan: planKey, userId: user.id, email: user.email };
        const response = await fetch('/api/choose-plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userData)
        });
        if (!response.ok) throw new Error('Failed to finalize plan: ' + response.statusText);
        await response.json();
        alert('Plan chosen! You can now generate today\'s plan.');
        $('planSelection').classList.add('hidden');
        await loadPlanForUser(user.id);
      } catch (err) { console.error(err); alert('Error: ' + err.message); }
    }

    async function generateTodayPlan() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) { alert('Please log in first.'); return; }

        // Get latest chosen plan
        const { data: existingPlan, error } = await supabaseClient
          .from('plans')
          .select('chosen_plan')
          .eq('user_id', user.id)
          .limit(1)
          .order('created_at', { ascending: false });
        if (error || !existingPlan || existingPlan.length===0 || !existingPlan[0].chosen_plan) {
          alert('No chosen plan found. Choose a weekly plan first.');
          return;
        }
        const chosenPlan = existingPlan[0].chosen_plan;

        // Call n8n webhook
        const response = await fetch('https://passiesport.app.n8n.cloud/webhook/generate-today-plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: user.id, email: user.email, chosenPlan })
        });
        if (!response.ok) throw new Error(`Failed to generate today's plan: ${response.status}`);
        const data = await response.json();
        console.log('Plan generated:', data);
        alert('Today’s plan generated successfully!');
        await loadPlanForUser(user.id);
      } catch (err) { console.error(err); alert('Error: ' + err.message); }
    }

    async function loadPreviousPlans() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;
        const { data, error } = await supabaseClient
          .from('plans')
          .select('chosen_plan, current_day, plan_date, plan_json')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });
        if (error) { previousPlansContent.innerHTML = 'Error loading history.'; return; }
        previousPlansContent.innerHTML = data.length===0 ? '<p>No previous plans found.</p>' :
          data.map(p => `
            <div class="mb-4 p-4 border rounded bg-white">
              <h4 class="font-semibold">Plan for ${p.plan_date} (Day ${p.current_day})</h4>
              <p><strong>Chosen Plan:</strong> ${p.chosen_plan || 'None'}</p>
              <pre class="text-xs mt-2 overflow-auto">${p.plan_json ? p.plan_json.replace(/\\n/g,'\n') : 'No details'}</pre>
            </div>
          `).join('');
      } catch (err) { console.error(err); }
    }

    generatePlanBtn.addEventListener('click', generatePlan);
    generateTodayBtn.addEventListener('click', generateTodayPlan);
    previousPlansBtn.addEventListener('click', () => { loadPreviousPlans(); showPreviousPlans(); });
    backToAppBtn.addEventListener('click', showApp);
    document.addEventListener('click', e => { 
      if(e.target.classList.contains('chooseBtn')) choosePlan(e.target.dataset.plan); 
    });

    (async () => {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (user) initApp(); else showAuth();
    })();

  </script>
</body>
</html>
